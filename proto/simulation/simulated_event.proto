/*

   calin/proto/simulations/simulated_event.proto -- Stephen Fegan -- 2026-01-02

   Protobufs for simulated events

   Copyright 2026, Stephen Fegan <sfegan@llr.in2p3.fr>
   Laboratoire Leprince-Ringuet, CNRS/IN2P3, Ecole Polytechnique, Institut Polytechnique de Paris

   This file is part of "calin"

   "calin" is free software: you can redistribute it and/or modify it
   under the terms of the GNU General Public License version 2 or
   later, as published by the Free Software Foundation.

   "calin" is distributed in the hope that it will be useful, but
   WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   General Public License for more details.

*/

syntax = "proto3";

import "calin.proto";
import "common_types.proto";
import "simulation/vcl_iact.proto";
import "simulation/geant4_shower_generator.proto";

package calin.ix.simulation.simulated_event;

message DetectorSphere
{
  calin.ix.common_types.Vector3D r0                        = 1
    [(CFO).desc = "Position of the detector.",
     (CFO).units = "cm" ];
  
  double radius                                            = 2
    [(CFO).desc = "Radius of the detector.",
     (CFO).units = "cm" ];

  uint32 iobs                                              = 3
    [(CFO).desc = "Observation layer associated with this detector." ];

  calin.ix.common_types.Vector3D obs_dir                   = 4
    [(CFO).desc = "Pointing direction of detector.",
     (CFO).units = "1" ];

  double field_of_view_radius                              = 5
    [(CFO).desc = "Field of view radius of detector.",
    (CFO).units = "degrees" ];
};

message PixelEvent
{
  int32 pixel_id                                           = 1
    [(CFO).desc = "Pixel identifier." ];

  repeated float time                                      = 2
    [(CFO).desc = "Photon detection times relative to detector reference time.",
     (CFO).units = "ns" ];

  repeated uint32 integer_time                             = 3
    [(CFO).desc = "Photon detection times relative to detector reference time stored as integer.",
     (CFO).units = "10ps", (CFO).int32_type = INT_16 ];

  repeated float weight                                    = 4
    [(CFO).desc = "Photon weights",
     (CFO).units = "1" ];
};

message DetectorEvent
{
  int32 detector_id                                        = 1
    [(CFO).desc = "Unique identifier for this detector within the group." ];

  double reference_time                                    = 2
    [(CFO).desc = "Detector reference (absolute) time for this event.",
     (CFO).units = "ns" ];

  double time_max                                          = 3
    [(CFO).desc = "Maximum photon detection time for this event relative to reference time.",
     (CFO).units = "ns" ];

  repeated PixelEvent pixel                                = 4
    [(CFO).desc = "Events for each pixel in this detector." ];
};

message DetectorGroupEvent
{
  repeated DetectorSphere sphere                           = 1
    [(CFO).desc = "Details of containing sphere and pointing direction for each detector in this group." ];

  repeated DetectorEvent detector                          = 10
    [(CFO).desc = "Events for each detector in this group that detected a photon." ];
};

message DetectorArrayEvent
{
  double scattered_distance                                = 1
    [(CFO).desc = "Scattered detector distance for this event.",
     (CFO).units = "cm" ];

  calin.ix.common_types.Vector3D scattered_offset          = 2
    [(CFO).desc = "Scattered detector offset for this event.",
     (CFO).units = "cm" ];

   repeated DetectorGroupEvent group                       = 10
    [(CFO).desc = "Events for each detector group in the array." ];
};

enum ParticleType { 
    GAMMA       = 0;
    ELECTRON    = 1;
    POSITRON    = 2;
    MUON        = 3;
    ANTI_MUON   = 4;
    PROTON      = 5;
    ANTI_PROTON = 6;
    NEUTRON     = 7;
    HELIUM      = 8;
    CARBON      = 9;
    OXYGEN      = 10;
    MAGNESIUM   = 11;
    SILICON     = 12;
    IRON        = 13;
    OTHER       = 14;
};

message SimulatedEvent 
{
  uint64 instance_id                                       = 1
    [(CFO).desc = "Identifier for simulation instance." ];

  uint64 event_id                                          = 2
    [(CFO).desc = "Identifier for event unique to simulation instance." ];

  ParticleType type                                        = 3
    [(CFO).desc = "Simplified particle type." ];

  int32 pdg_type                                           = 4
    [(CFO).desc = "PDG particle type code." ];   

  double q                                                 = 5
    [(CFO).desc = "Particle charge.",
     (CFO).units = "e" ];

  double mass                                              = 6
    [(CFO).desc = "Particle rest mass.",
     (CFO).units = "MeV" ];

  calin.ix.common_types.Vector3D x0                        = 7
    [(CFO).desc = "Position of start of event.",
     (CFO).units = "cm" ];

  calin.ix.common_types.Vector3D u0                        = 8
    [(CFO).desc = "Direction of start of event.",
     (CFO).units = "1" ];

  double energy                                            = 9
    [(CFO).desc = "Primary energy at start of event.",
     (CFO).units = "MeV" ];

  double t0                                                = 10  
    [(CFO).desc = "Time at start of event.",
     (CFO).units = "ns" ];

  double weight                                            = 11
    [(CFO).desc = "Event weighting for thinning." ];

  calin.ix.common_types.Vector3D viewcone_axis             = 12
    [(CFO).desc = "Nominal viewcone axis for this event.",
     (CFO).units = "1" ];

  double viewcone_costheta                                 = 13
    [(CFO).desc = "Costheta of event direction with respect to nominal viewcone axis." ];

  repeated DetectorArrayEvent array                        = 20
    [(CFO).desc = "Event as seen by each of the configured detector arrays." ];
};

message AtmosphericLevel
{
  double altitude                                          = 1
    [(CFO).desc = "Altitude of level.",
     (CFO).units = "cm" ];

  double thickness                                         = 2
    [(CFO).desc = "Thickness from infinity to level.",
     (CFO).units = "g/cm2" ];

  double density                                           = 3
    [(CFO).desc = "Density at level.",
     (CFO).units = "g/cm3" ];

  double n_minus_one                                       = 4
    [(CFO).desc = "Refractive index minus 1 at level.",
     (CFO).units = "1" ];

  calin.ix.common_types.Vector3D bfield                    = 10
    [(CFO).desc = "Geomagnetic field vector at level.",
     (CFO).units = "nT" ];

  double optical_depth_1d5ev                               = 20
    [(CFO).desc = "Optical depth for 1.5 eV photon from level." ];

  double optical_depth_2d0ev                               = 21
    [(CFO).desc = "Optical depth for 2.0 eV photon from level." ];

  double optical_depth_2d5ev                               = 22
    [(CFO).desc = "Optical depth for 2.5 eV photon from level." ];

  double optical_depth_3d0ev                               = 23
    [(CFO).desc = "Optical depth for 3.0 eV photon from level." ];

  double optical_depth_3d5ev                               = 24
    [(CFO).desc = "Optical depth for 3.5 eV photon from level." ];

  double optical_depth_4d0ev                               = 25
    [(CFO).desc = "Optical depth for 4.0 eV photon from level." ];
};

message DetectorGroupConfiguration
{
  string name                                              = 1
    [(CFO).desc = "Name of this detector group." ];

  uint32 ndetector                                         = 2
    [(CFO).desc = "Number of detectors in this group" ];

  uint32 detector0                                         = 3
    [(CFO).desc = "Index of first detector in this group." ];
  
  string propagator_banner                                 = 10
    [(CFO).desc = "Banner or description for the propagator." ];

  string bandwidth_manager_banner                          = 11
    [(CFO).desc = "Banner or description for the bandwidth manager." ];

  string pe_processor_banner                               = 12
    [(CFO).desc = "Banner or description for the PE processor." ];

  double pe_time_spread                                    = 13
    [(CFO).desc = "Time resolution for pe detector.",
     (CFO).units = "ns" ];
};

message DetectorArrayConfiguration
{
  string name                                              = 1
    [(CFO).desc = "Name of this detector set." ];

  repeated double scattering_radius_polynomial             = 40
    [(CFO).desc = "Radius of the scattering region for the array center, "
      "perpendicular to primary direction, defined as a polynomial of "
      "x=log10(E/1TeV): R = P0 + P1*x + P2*x^2 + ...",
     (CFO).units = "cm" ];

  repeated DetectorGroupConfiguration detector_group_config = 10
    [(CFO).desc = "Configuration for the detector groups in this set."];
};  

message SimulationConfiguration
{
  ParticleType particle_type                               = 1
    [(CFO).desc = "Simplified particle type." ];

  double energy_lo                                         = 2
    [(CFO).desc = "Low energy bound for simulated events.",
     (CFO).units = "TeV" ];

  double energy_hi                                         = 3
    [(CFO).desc = "High energy bound for simulated events.",
     (CFO).units = "TeV" ];

  repeated double energy_spectrum_polynomial               = 4
    [(CFO).desc = "Energy spectrum shape index for simulated events as "
      " a polynomial in x=log10(E/1TeV). dF/dE ~ 10^(P0*x + P1*x^2 + ...)." ];

  double elevation                                         = 5
    [(CFO).desc = "Elevation of the nominal observation axis for the simulation.",
     (CFO).units = "degrees" ];     

  double azimuth                                           = 6
    [(CFO).desc = "Azimuth of nominal observation axis for the simulation.",
     (CFO).units = "degrees" ];

  double theta                                             = 7
    [(CFO).desc = "Radial offset distance of nominal primary axis with respect to the observation direction.",
     (CFO).units = "degrees" ];

  double phi                                               = 8
    [(CFO).desc = "Polar angle of of nominal source primary axis with respect to the observation direction.",
     (CFO).units = "degrees" ];     

  calin.ix.common_types.Vector3D primary_axis              = 9
    [(CFO).desc = "Nominal source primary direction vector.",
     (CFO).units = "1" ];

  repeated double viewcone_halfangle_polynomial            = 10
    [(CFO).desc = "Half-angle of the scattering viewcone for the primary direction "
      "with respect to the nominal direction, defined as a polynomial of "
      "x=log10(E/1TeV): R = P0 + P1*x + P2*x^2 + ...",
     (CFO).units = "degrees" ];

  repeated double scattering_radius_polynomial             = 11
    [(CFO).desc = "Radius of the scattering region for the array center, "
      "perpendicular to primary direction, defined as a polynomial of "
      "x=log10(E/1TeV): R = P0 + P1*x + P2*x^2 + ...",
     (CFO).units = "m" ];

  string banner                                            = 20
    [(CFO).desc = "Banner or description for this simulation run." ];

  repeated AtmosphericLevel atmospheric_level              = 21
    [(CFO).desc = "Atmospheric levels." ];

  calin.ix.simulation.geant4_shower_generator.GEANT4ShowerGeneratorConfiguration geant4_shower_generator_config = 22
    [(CFO).desc = "Configuration for GEANT4 shower generation." ];

  calin.ix.simulation.vcl_iact.VCLIACTArrayConfiguration iact_array_config = 23
    [(CFO).desc = "Configuration for IACT array simulation." ];

  DetectorArrayConfiguration detector_array_config         = 24
    [(CFO).desc = "Configuration for detector arrays in this simulation." ];

  map<string, string> command_line_args                    = 100
    [(CFO).desc = "Extra configuration parameters as key-value pairs." ];
};